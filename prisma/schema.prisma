// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String             @id @default(uuid())
  joinedAt            DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  email               String             @unique
  role                Role               @default(USER)
  isActive            Boolean            @default(true)
  password            String
  passwordChangedAt   DateTime           @default(now())
  passwordResetToken  String?            @unique
  passwordTokenExpiry DateTime?
  profile             Profile?
  posts               Post[]
  organization        Organization?      @relation(fields: [organizationId], references: [id])
  organizationId      String?
  isAdmin             Boolean            @default(false)
  isModerator         Boolean            @default(false)
  // ownedOrganization   Organization  @relation("admin")
  // Organization        Organization  @relation("moderator")
  projectOwned        ProjectRoles[]     @relation("owner")
  projectManaged      ProjectRoles[]     @relation("manager")
  projectDeveloped    ProjectRoles[]     @relation("developer")
  // Project             Project[]
  postComment         PostComment[]
  ticketComment       TicketComment[]
  ticketCreator       TicketRoles?       @relation("creator")
  ticketVarifier      TicketRoles?       @relation("varifier")
  ticketCloser        TicketRoles?       @relation("closer")
  ticketAssigner      TicketRoles?       @relation("assign")
  developerTicket     TicketRoles[]
  projectXFeatures    ProjectXFeatures[]
}

enum Role {
  USER
  ADMIN
}

model Profile {
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String        @id
  bio            String?
  name           String
  username       String        @unique
  country        String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?
  birthday       DateTime?
  photo          String?
}

// model preferences

model Post {
  id              String   @id @default(uuid())
  createdAt       DateTime @default(now())
  title           String
  published       Boolean  @default(false)
  updatedAt       DateTime @updatedAt
  summary         String
  slug            String   @unique
  postContent     String
  attachmentFiles String[]
  isPublic        Boolean  @default(true)

  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId String

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?

  refProject   Project? @relation(fields: [refProjectId], references: [id])
  refProjectId String?

  refFeature    ProjectXFeatures? @relation(fields: [refProjectId, refFeaturesId], references: [projectId, featuresId])
  refFeaturesId String?

  // views
  // rating
  // categories Category[]
  // contributor
  // comment - #comment
  // privacy
  postComment PostComment[]
  project     Project?      @relation("basePost")
  features    Features?
}

model Organization {
  id          String    @id @default(uuid())
  name        String
  description String
  customURL   String    @unique
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  updateLog   String
  // 	- time - by whom - action  // create a folder and store there?
  profile     Profile[] // member profiles
  user        User[] // members
  post        Post[] // posts owned by organization
  project     Project[]
}

model Project {
  id        String   @id @default(uuid())
  customURL String   @unique
  title     String
  summary   String
  createdAt DateTime @default(now())
  updatedAt DateTime

  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?

  projectRoles ProjectRoles?

  status   ProjectStatus
  isPublic Boolean       @default(true)

  basePost   Post   @relation("basePost", fields: [basePostId], references: [id])
  basePostId String @unique

  // status - in dev | released version | depricated
  // 			project page shows the 
  // 						project details
  // 						issues associated
  // 						different roles
  // 						comments
  // 						features
  post             Post[]
  projectXFeatures ProjectXFeatures[]
  ticket           Ticket[]
}

enum ProjectStatus {
  PROPOSED
  IN_DEVELOPMENT
  ACTIVE
  MAINTAINED
  NOT_MAINTAINED
  OBSOLETE
}

model ProjectRoles {
  // id String @id @default(uuid())

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String  @id
  // if org, owner = org owner
  owner     User    @relation("owner", fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId   String

  manager   User?   @relation("manager", fields: [managerId], references: [id])
  managerId String?

  developers User[] @relation("developer")
}

// author, is public
model Features {
  id               String             @id @default(uuid())
  title            String
  description      String
  necessaryLinks   String[]
  process          String
  isPublic         Boolean            @default(true)
  projectXFeatures ProjectXFeatures[]

  basePost Post   @relation(fields: [postId], references: [id])
  postId   String @unique
}

model ProjectXFeatures {
  project     Project     @relation(fields: [projectId], references: [id])
  projectId   String
  feature     Features    @relation(fields: [featuresId], references: [id])
  featuresId  String
  featureType FeatureType @default(ACTIVE)
  owner       User        @relation(fields: [ownerId], references: [id])
  ownerId     String
  ticket      Ticket[]
  post        Post[]

  @@id([projectId, featuresId])
}

enum FeatureType {
  MAINTAINED
  ACTIVE
  DEPRICATED
  OBSOLETE
}

model PostComment {
  id String @id @default(uuid())

  author    User     @relation(fields: [authorId], references: [id])
  authorId  String
  updatedAt DateTime @updatedAt
  text      String
  // postedAt DateTime @default(now())

  parentPost   Post   @relation(fields: [parentPostId], references: [id])
  parentPostId String

  predecessorId String?
  predecessor   PostComment?  @relation("commentHistory", fields: [predecessorId], references: [id])
  successor     PostComment[] @relation("commentHistory")
}

model TicketComment {
  id String @id @default(uuid())

  author    User     @relation(fields: [authorId], references: [id])
  authorId  String
  updatedAt DateTime @updatedAt
  text      String

  parentTicket   Ticket @relation(fields: [parentTicketId], references: [id])
  parentTicketId String

  predecessorId String?
  predecessor   TicketComment?  @relation("commentHistory", fields: [predecessorId], references: [id])
  successor     TicketComment[] @relation("commentHistory")
}

model Ticket {
  id             String         @id @default(uuid())
  title          String
  description    String
  createdAt      DateTime       @default(now())
  closedAt       DateTime?
  updatedAt      DateTime       @updatedAt
  ticketType     TicketType
  ticketSeverity TicketSeverity
  ticketPriority TicketPriority

  project                    Project           @relation(fields: [projectId], references: [id])
  projectId                  String
  feature                    ProjectXFeatures? @relation(fields: [projectId, projectXFeaturesFeaturesId], references: [projectId, featuresId])
  projectXFeaturesFeaturesId String?

  ticketComment TicketComment[]
  ticketRoles   TicketRoles?
}

enum TicketType {
  BUG
  ISSUE
  ENHANCEMENT
  FEATURE_REQUEST
}

enum TicketSeverity {
  CRITICAL
  MAJOR
  MINOR
  LOW
  OPTIONAL
}

enum TicketPriority {
  HIGH
  MEDIUM
  LOW
}

model TicketRoles {
  id String @id @default(uuid())

  // status - closed_at = closed, varified_by = waiting for varification
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  ticketId String @unique

  creator   User   @relation("creator", fields: [creatorId], references: [id])
  creatorId String @unique

  varifiedBy User?   @relation("varifier", fields: [varifierId], references: [id]) // (admin| manager| owner)
  varifierId String? @unique

  closedBy User?   @relation("closer", fields: [closeId], references: [id]) // (admin| manager| owner)
  closeId  String? @unique

  assignedBy User?   @relation("assign", fields: [assignedId], references: [id]) // (admin| manager| owner)
  assignedId String? @unique

  developers User[]
}
